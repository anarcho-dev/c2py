#!/usr/bin/env python3
"""
Exploit Generator Dialog
GUI for exploit generation and management
"""

from PyQt6.QtWidgets import *
from PyQt6.QtCore import *
from PyQt6.QtGui import *
from exploit_generator import ExploitGenerator


class ExploitDialog(QDialog):
    """
    Dialog for exploitgeneration and management
    """
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Exploit Generator - Professional Grade")
        self.setMinimumWidth(900)
        self.setMinimumHeight(700)
        
        self.exploit_gen = ExploitGenerator()
        self.setup_ui()
        
        # Apply dark theme
        if parent:
            self.setStyleSheet(parent.styleSheet())
    
    def setup_ui(self):
        """Setup the UI"""
        layout = QVBoxLayout(self)
        
        # Header
        header = QLabel("üéØ Exploit Generator")
        header.setStyleSheet("font-size: 18px; font-weight: bold; color: #8b5cf6; padding: 10px;")
        layout.addWidget(header)
        
        # Splitter for two-column layout
        splitter = QSplitter(Qt.Orientation.Horizontal)
        
        # Left panel - Exploit selection
        left_panel = self.create_exploit_selection_panel()
        splitter.addWidget(left_panel)
        
        # Right panel - Exploit details
        right_panel = self.create_exploit_details_panel()
        splitter.addWidget(right_panel)
        
        splitter.setStretchFactor(0, 1)
        splitter.setStretchFactor(1, 2)
        
        layout.addWidget(splitter)
        
        # Bottom buttons
        button_layout = QHBoxLayout()
        
        self.copy_btn = QPushButton("üìã Copy Command")
        self.copy_btn.clicked.connect(self.copy_exploit_command)
        self.copy_btn.setEnabled(False)
        button_layout.addWidget(self.copy_btn)
        
        self.execute_btn = QPushButton("üöÄ Execute (Terminal)")
        self.execute_btn.clicked.connect(self.execute_exploit)
        self.execute_btn.setEnabled(False)
        button_layout.addWidget(self.execute_btn)
        
        button_layout.addStretch()
        
        close_btn = QPushButton("Close")
        close_btn.clicked.connect(self.accept)
        button_layout.addWidget(close_btn)
        
        layout.addLayout(button_layout)
    
    def create_exploit_selection_panel(self):
        """Create left panel with exploit categories"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        
        # Category combo
        cat_label = QLabel("üìÅ Exploit Category:")
        layout.addWidget(cat_label)
        
        self.category_combo = QComboBox()
        self.category_combo.addItems(self.exploit_gen.get_categories())
        self.category_combo.currentTextChanged.connect(self.on_category_changed)
        layout.addWidget(self.category_combo)
        
        # Exploit list
        exploit_label = QLabel("üéØ Available Exploits:")
        layout.addWidget(exploit_label)
        
        self.exploit_list = QListWidget()
        self.exploit_list.currentRowChanged.connect(self.on_exploit_selected)
        layout.addWidget(self.exploit_list)
        
        # OS suggestion section
        os_group = QGroupBox("üîç Target OS Detection")
        os_layout = QVBoxLayout()
        
        os_input_layout = QHBoxLayout()
        os_input_layout.addWidget(QLabel("OS Type:"))
        self.os_type_input = QLineEdit()
        self.os_type_input.setPlaceholderText("e.g., Windows, Linux")
        os_input_layout.addWidget(self.os_type_input)
        os_layout.addLayout(os_input_layout)
        
        version_layout = QHBoxLayout()
        version_layout.addWidget(QLabel("Version:"))
        self.os_version_input = QLineEdit()
        self.os_version_input.setPlaceholderText("e.g., 10, 7, 5.x")
        version_layout.addWidget(self.os_version_input)
        os_layout.addLayout(version_layout)
        
        suggest_btn = QPushButton("üí° Suggest Exploits")
        suggest_btn.clicked.connect(self.suggest_exploits_for_os)
        os_layout.addWidget(suggest_btn)
        
        os_group.setLayout(os_layout)
        layout.addWidget(os_group)
        
        layout.addStretch()
        
        # Initialize with first category
        if self.category_combo.count() > 0:
            self.on_category_changed(self.category_combo.currentText())
        
        return panel
    
    def create_exploit_details_panel(self):
        """Create right panel with exploit details"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        
        # Exploit info
        info_label = QLabel("üìã Exploit Details:")
        layout.addWidget(info_label)
        
        self.exploit_info = QTextEdit()
        self.exploit_info.setReadOnly(True)
        self.exploit_info.setMaximumHeight(200)
        layout.addWidget(self.exploit_info)
        
        # Configuration
        config_group = QGroupBox("‚öôÔ∏è Configuration")
        config_layout = QFormLayout()
        
        self.target_input = QLineEdit()
        self.target_input.setPlaceholderText("192.168.1.100")
        config_layout.addRow("üéØ Target IP:", self.target_input)
        
        self.lhost_input = QLineEdit()
        self.lhost_input.setPlaceholderText("192.168.1.50")
        config_layout.addRow("üì° LHOST (Attacker):", self.lhost_input)
        
        self.lport_input = QLineEdit()
        self.lport_input.setText("4444")
        self.lport_input.setPlaceholderText("4444")
        config_layout.addRow("üîå LPORT:", self.lport_input)
        
        # Additional fields
        self.username_input = QLineEdit()
        self.username_input.setPlaceholderText("optional")
        config_layout.addRow("üë§ Username:", self.username_input)
        
        self.password_input = QLineEdit()
        self.password_input.setPlaceholderText("optional")
        self.password_input.setEchoMode(QLineEdit.EchoMode.Password)
        config_layout.addRow("üîë Password:", self.password_input)
        
        self.domain_input = QLineEdit()
        self.domain_input.setPlaceholderText("optional")
        config_layout.addRow("üåê Domain:", self.domain_input)
        
        config_group.setLayout(config_layout)
        layout.addWidget(config_group)
        
        # Generate button
        generate_btn = QPushButton("üî® Generate Exploit Command")
        generate_btn.clicked.connect(self.generate_exploit_command)
        layout.addWidget(generate_btn)
        
        # Command output
        cmd_label = QLabel("üíª Generated Command:")
        layout.addWidget(cmd_label)
        
        self.command_output = QTextEdit()
        self.command_output.setReadOnly(True)
        self.command_output.setPlaceholderText("Generate an exploit command to see it here...")
        layout.addWidget(self.command_output)
        
        return panel
    
    def on_category_changed(self, category: str):
        """Handle category change"""
        self.exploit_list.clear()
        exploits = self.exploit_gen.get_exploits_in_category(category)
        self.exploit_list.addItems(exploits)
    
    def on_exploit_selected(self, row: int):
        """Handle exploit selection"""
        if row == -1:
            return
        
        category = self.category_combo.currentText()
        exploit_name = self.exploit_list.currentItem().text()
        
        # Get exploit details
        details = self.exploit_gen.get_exploit_details(category, exploit_name)
        
        # Display details
        info_text = f"<h3>{exploit_name}</h3>"
        if 'cve' in details:
            info_text += f"<p><b>CVE:</b> {details['cve']}</p>"
        if 'description' in details:
            info_text += f"<p><b>Description:</b> {details['description']}</p>"
        if 'requirements' in details:
            info_text += "<p><b>Requirements:</b></p><ul>"
            for req in details['requirements']:
                info_text += f"<li>{req}</li>"
            info_text += "</ul>"
        if 'payload_types' in details:
            info_text += "<p><b>Payload Types:</b></p><ul>"
            for payload in details['payload_types']:
                info_text += f"<li>{payload}</li>"
            info_text += "</ul>"
        
        self.exploit_info.setHtml(info_text)
    
    def suggest_exploits_for_os(self):
        """Suggest exploits based on OS"""
        os_type = self.os_type_input.text().strip()
        os_version = self.os_version_input.text().strip()
        
        if not os_type:
            QMessageBox.warning(self, "Input Required", "Please enter an OS type")
            return
        
        suggestions = self.exploit_gen.suggest_exploits(os_type, os_version)
        
        if not suggestions:
            QMessageBox.information(self, "No Suggestions", 
                                  f"No specific exploits found for {os_type} {os_version}")
            return
        
        # Show suggestions dialog
        dialog = QDialog(self)
        dialog.setWindowTitle(f"Exploit Suggestions for {os_type} {os_version}")
        dialog.setMinimumWidth(600)
        dialog.setMinimumHeight(400)
        
        layout = QVBoxLayout(dialog)
        
        list_widget = QListWidget()
        for category, name, details in suggestions:
            item = QListWidgetItem(f"[{category}] {name}")
            item.setData(Qt.ItemDataRole.UserRole, (category, name))
            list_widget.addItem(item)
        
        layout.addWidget(list_widget)
        
        button_layout = QHBoxLayout()
        select_btn = QPushButton("Select")
        select_btn.clicked.connect(lambda: self.select_suggested_exploit(list_widget, dialog))
        button_layout.addWidget(select_btn)
        
        close_btn = QPushButton("Close")
        close_btn.clicked.connect(dialog.reject)
        button_layout.addWidget(close_btn)
        
        layout.addLayout(button_layout)
        
        dialog.exec()
    
    def select_suggested_exploit(self, list_widget, dialog):
        """Select an exploit from suggestions"""
        if not list_widget.currentItem():
            return
        
        category, name = list_widget.currentItem().data(Qt.ItemDataRole.UserRole)
        
        # Set category
        index = self.category_combo.findText(category)
        if index >= 0:
            self.category_combo.setCurrentIndex(index)
        
        # Set exploit
        for i in range(self.exploit_list.count()):
            if self.exploit_list.item(i).text() == name:
                self.exploit_list.setCurrentRow(i)
                break
        
        dialog.accept()
    
    def generate_exploit_command(self):
        """Generate exploit command with config"""
        category = self.category_combo.currentText()
        if self.exploit_list.currentRow() == -1:
            QMessageBox.warning(self, "Selection Required", "Please select an exploit")
            return
        
        exploit_name = self.exploit_list.currentItem().text()
        target = self.target_input.text().strip()
        lhost = self.lhost_input.text().strip()
        lport = self.lport_input.text().strip()
        
        if not all([target, lhost, lport]):
            QMessageBox.warning(self, "Configuration Required", 
                              "Please fill in Target IP, LHOST, and LPORT")
            return
        
        try:
            lport_int = int(lport)
        except ValueError:
            QMessageBox.warning(self, "Invalid Port", "LPORT must be a number")
            return
        
        # Build kwargs
        kwargs = {}
        if self.username_input.text().strip():
            kwargs['username'] = self.username_input.text().strip()
        if self.password_input.text().strip():
            kwargs['password'] = self.password_input.text().strip()
        if self.domain_input.text().strip():
            kwargs['domain'] = self.domain_input.text().strip()
        
        # Generate command
        command = self.exploit_gen.get_exploit_command(
            category, exploit_name, target, lhost, lport_int, **kwargs
        )
        
        if command:
            self.command_output.setText(command)
            self.copy_btn.setEnabled(True)
            self.execute_btn.setEnabled(True)
        else:
            self.command_output.setText("Failed to generate command")
            self.copy_btn.setEnabled(False)
            self.execute_btn.setEnabled(False)
    
    def copy_exploit_command(self):
        """Copy command to clipboard"""
        command = self.command_output.toPlainText()
        if command:
            clipboard = QApplication.clipboard()
            clipboard.setText(command)
            QMessageBox.information(self, "Copied", "Command copied to clipboard")
    
    def execute_exploit(self):
        """Execute exploit in terminal"""
        command = self.command_output.toPlainText()
        if not command:
            return
        
        reply = QMessageBox.question(self, "Execute Exploit", 
                                    "Execute this exploit in a new terminal?\n\n"
                                    "WARNING: Only use on systems you have authorization to test!",
                                    QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
        
        if reply == QMessageBox.StandardButton.Yes:
            import subprocess
            import platform
            
            system = platform.system().lower()
            
            try:
                if system == 'linux' or system == 'darwin':
                    # Try different terminal emulators
                    terminals = [
                        ['gnome-terminal', '--', 'bash', '-c'],
                        ['xterm', '-e'],
                        ['konsole', '-e', 'bash', '-c'],
                        ['terminator', '-e'],
                    ]
                    
                    for term_cmd in terminals:
                        try:
                            subprocess.Popen(term_cmd + [command + '; exec bash'])
                            break
                        except FileNotFoundError:
                            continue
                    else:
                        QMessageBox.warning(self, "No Terminal", 
                                          "Could not find a suitable terminal emulator.\n"
                                          "Please copy and execute manually.")
                else:
                    QMessageBox.information(self, "Manual Execution", 
                                          "Please copy the command and execute it manually in your terminal.")
            except Exception as e:
                QMessageBox.critical(self, "Execution Error", f"Failed to execute: {e}")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    dialog = ExploitDialog()
    dialog.show()
    sys.exit(app.exec())
